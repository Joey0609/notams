name: Update Visits Badge

on:
  push:
    branches: ["main"]
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 2:00 è¿è¡Œï¼ˆä½ å¯ä»¥è°ƒæ•´ï¼‰
    - cron: '0 2 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: gh-pages  # â† æ›¿æ¢ä¸ºä½ çš„ GitHub Pages åˆ†æ”¯åï¼ˆå¦‚ mainï¼‰

      - name: Fetch counter.dev data
        run: |
          curl -s "https://counter.dev/dump?user=Starsky69&token=Beb6_vARt7c=&utcoffset=8" > counter.json

      - name: Extract visits and generate visits.json
        run: |
          # ä½¿ç”¨ jq æå– /notams/ çš„æ€»è®¿é—®é‡ï¼ˆall.page["/notams/"]ï¼‰
          VISITS=$(jq -r '.payload.sites["joey0609.github.io"].visits.all.page["/notams/"] // 0' counter.json)
          echo "{\"value\": $VISITS}" > notams/visits.json
          cat notams/visits.json

      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add notams/visits.json
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ¤– Auto-update visits.json [$(date -u)]"
            git push
          else
            echo "No changes to commit."
          fi